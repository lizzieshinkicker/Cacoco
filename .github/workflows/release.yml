name: Release

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '0 3 * * *'
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  activity-check:
    name: Check for repo activity
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      nightly-outdated: ${{ steps.check.outputs.nightly-outdated }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check latest nightly commit
        id: check
        run: |
          if git fetch --quiet origin refs/tags/nightly:refs/tags/nightly; then
            TAG_COMMIT=$(git rev-list -n 1 refs/tags/nightly)

            if [[ "$TAG_COMMIT" != "${{ github.sha }}" ]]; then
              echo "nightly-outdated=true" >> "$GITHUB_OUTPUT"
            else
              echo "nightly-outdated=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "nightly-outdated=true" >> "$GITHUB_OUTPUT"
          fi

  version:
    name: Get version name
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      appimage-version: ${{ steps.version.outputs.appimage-version }}
      appimage-release-tag: ${{ steps.version.outputs.release-tag }}
    steps:
    - uses: actions/checkout@v6
    - name: Read version name from git
      id: version
      run: |
        if [[ "${{ github.event_name }}" != "release" ]]; then
          SHORT_HASH=$(git rev-parse --short ${{ github.sha }})
          echo "version=nightly" >> "$GITHUB_OUTPUT"
          echo "appimage-version=nightly-$SHORT_HASH" >> "$GITHUB_OUTPUT"
          echo "release-tag=nightly" >> "$GITHUB_OUTPUT"
        else
          echo "version=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          echo "appimage-version=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          echo "release-tag=latest" >> "$GITHUB_OUTPUT"
        fi

  build-windows:
    name: Build (Windows)
    needs: version
    runs-on: windows-latest
    env:
      RELEASE_VERSION: ${{ needs.version.outputs.version }}
    steps:
    - uses: actions/checkout@v6
    - uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
      with:
        target: x86_64-pc-windows-msvc
    - name: Build release binary
      run: cargo build --release --target x86_64-pc-windows-msvc
    - name: Rename binary
      run: |
        mkdir -p dist
        mv target/x86_64-pc-windows-msvc/release/cacoco.exe dist/cacoco-${{ env.RELEASE_VERSION }}-windows.exe
    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: windows-${{ env.RELEASE_VERSION }}
        path: dist/*

  build-mac:
    name: Build (macOS)
    # macOS binaries aren't really ready for real releases yet
    if: github.event_name != 'release'
    needs: version
    runs-on: macos-latest
    env:
      RELEASE_VERSION: ${{ needs.version.outputs.version }}
    steps:
    - uses: actions/checkout@v6
    - uses: actions-rust-lang/setup-rust-toolchain@v1.15.2
      with:
        target: |
          aarch64-apple-darwin
          x86_64-apple-darwin
    - name: Build release binary (ARM)
      run: cargo build --release --target aarch64-apple-darwin
    - name: Build release binary (x86_64)
      run: cargo build --release --target x86_64-apple-darwin
    - name: Create macOS universal binary
      run: |
        mkdir -p dist
        lipo -create \
          target/aarch64-apple-darwin/release/cacoco \
          target/x86_64-apple-darwin/release/cacoco \
          -output dist/cacoco-${{ env.RELEASE_VERSION }}-mac
    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: macos-${{ env.RELEASE_VERSION }}
        path: dist/*

  build-linux:
    name: Build (Linux)
    needs: version
    runs-on: ubuntu-latest
    env:
      APPIMAGE_VERSION: ${{ needs.version.outputs.appimage-version }}
      RELEASE_VERSION: ${{ needs.version.outputs.version }}
      ARTIFACT_NAME: cacoco-${{ needs.version.outputs.version }}-linux-x86_64.AppImage
      UPDATE_TAG: ${{ needs.version.outputs.appimage-release-tag }}
    steps:
    - uses: actions/checkout@v6
    - name: Build release binary (Debian Bullseye)
      run: |
        docker run --rm \
          -v "$PWD:/build" \
          -w /build \
          rust:bullseye \
          cargo build --release --target x86_64-unknown-linux-gnu
    - name: Install LinuxDeploy
      id: install-linuxdeploy
      uses: miurahr/install-linuxdeploy-action@v1.8.0
      with:
        plugins: appimage
    - name: Create AppImage
      env:
        LD_BIN: ${{ steps.install-linuxdeploy.outputs.linuxdeploy }}
        LDAI_UPDATE_INFORMATION: "gh-releases-zsync|${{ github.repository_owner }}|Cacoco|${{ env.UPDATE_TAG }}|${{ env.ARTIFACT_NAME }}.zsync"
        LDAI_VERSION: ${{ env.APPIMAGE_VERSION }}
        LDAI_OUTPUT: ${{ env.ARTIFACT_NAME }}
      run: |
        "$LD_BIN" --output appimage \
                  --executable target/x86_64-unknown-linux-gnu/release/cacoco \
                  --desktop-file packaging/linux/cacoco.desktop \
                  --icon-file ./icon.png \
                  --icon-filename cacoco \
                  --appdir ./AppDir
    - name: Rename binary
      run: |
        mkdir -p dist
        mv "${ARTIFACT_NAME}" "dist/${ARTIFACT_NAME}"
        mv "${ARTIFACT_NAME}.zsync" "dist/${ARTIFACT_NAME}.zsync"
    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: linux-${{ env.RELEASE_VERSION }}
        path: dist/*

  release-nightly:
    name: Create nightly release
    needs: [ build-windows, build-mac, build-linux, activity-check ]
    if: github.event_name != 'release' && (github.event_name == 'workflow_dispatch' || needs.activity-check.outputs.nightly-outdated == 'true')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Check existing nightly release commit
      id: check
      run: |
        existing_sha=$(gh release view nightly --json targetCommitish --jq .targetCommitish 2>/dev/null || echo "")
        echo "existing_sha=$existing_sha"
        if [[ "$existing_sha" = "${{ github.sha }}" ]]; then
          echo "release-exists=true" >> $GITHUB_OUTPUT
        else
          echo "release-exists=false" >> $GITHUB_OUTPUT
        fi
    - uses: actions/download-artifact@v7
      if: steps.check.outputs.release-exists == 'false'
      with:
        path: artifacts
    - name: Delete old nightly release
      if: steps.check.outputs.release-exists == 'false'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release delete nightly --yes || true
        git push origin :nightly || true
    - name: Create nightly release
      if: steps.check.outputs.release-exists == 'false'
      uses: softprops/action-gh-release@v2.5.0
      with:
        tag_name: nightly
        target_commitish: ${{ github.sha }}
        name: "Cacoco nightly build"
        prerelease: true
        make_latest: false
        draft: false
        overwrite_files: true
        generate_release_notes: true
        body: ""
        files: |
          artifacts/**/*

  release:
    name: Upload assets to release
    needs: [ build-windows, build-linux ]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v7
      with:
        path: artifacts
    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v2.5.0
      with:
        files: |
          artifacts/**/*